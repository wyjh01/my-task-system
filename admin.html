// main.js - 替换旧的 handleAdminPage 函数

function handleAdminPage() {
    const addTaskForm = document.getElementById('add-task-form');
    if (!addTaskForm) return;

    // 控制指派ID输入框的显示/隐藏
    const userIdWrapper = document.getElementById('user-id-wrapper');
    document.querySelectorAll('input[name="taskType"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            if (e.target.value === 'private') {
                userIdWrapper.style.display = 'block';
                document.getElementById('user-id').required = true;
            } else {
                userIdWrapper.style.display = 'none';
                document.getElementById('user-id').required = false;
            }
        });
    });

    addTaskForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const title = document.getElementById('task-title').value;
        const link = document.getElementById('task-link').value;
        const taskType = document.querySelector('input[name="taskType"]:checked').value;
        const messageEl = document.getElementById('admin-message');

        let taskData = { title, link };
        let errorMessage = '';

        if (taskType === 'private') {
            const userId = document.getElementById('user-id').value;
            if (!userId.trim()) {
                errorMessage = '指派模式下，用户ID不能为空！';
            } else {
                taskData.is_private = true;
                taskData.user_id = userId;
                taskData.status = '已领取'; // 指派任务直接设为“已领取”状态
                taskData.claimed_at = new Date();
            }
        } else {
            taskData.is_private = false;
            // status 会使用数据库默认值 '未领取'
        }
        
        if (errorMessage) {
            messageEl.textContent = errorMessage;
            messageEl.className = 'mt-3 alert alert-danger';
            return;
        }

        const { data, error } = await supabase.from('tasks').insert([taskData]);

        if (error) {
            messageEl.textContent = '发布失败: ' + error.message;
            messageEl.className = 'mt-3 alert alert-danger';
        } else {
            messageEl.textContent = '任务发布成功！';
            messageEl.className = 'mt-3 alert alert-success';
            addTaskForm.reset();
            userIdWrapper.style.display = 'none'; // 重置UI
        }
    });
}